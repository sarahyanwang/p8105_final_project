---
title: "regression_model"
author: "Dantong Zhu"
date: "2021/12/7"
output: html_document
---

```{r}
library(tidyverse)

source("code/data_cleaning.R")
source("code/formatting.R")

head(violation)
```

```{r warning=FALSE, message=FALSE}
violation_df = 
  violation %>%
  count(vehicle_body_type) %>% 
  mutate(
    vehicle_body_type = fct_reorder(vehicle_body_type, n) 
  ) %>% 
  ggplot(aes(x = vehicle_body_type, y = n)) +
  geom_point() +
  geom_bar() +
  labs(
    title = "Frequency of Violation in Vehicle Body Types",
    x = "Vehicle Body Types",
    y = "Numbers"
  )
```

model1: explore the regression model for number of vehicle_body_type and amount_due.
```{r warning=FALSE, message=FALSE}
body_type_effect = 
  lm(amount_due ~ vehicle_body_type, data = violation)

body_type_effect %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 2)
```

model2: explore the regression model for vehicle_year(somewhat/ideally represent the driver's experience) and amount_due.
```{r warning=FALSE, message=FALSE}
vehicle_year_effect = 
  lm(amount_due ~ vehicle_year, data = violation)

vehicle_year_effect %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 2)
```

model3: collective impact
```{r warning=FALSE, message=FALSE}
collective_effect = 
  lm(amount_due ~ vehicle_year + vehicle_body_type, data = violation)

collective_effect %>% 
  broom::tidy() %>% 
  knitr::kable(digits = 2)
```

Cross Validation
```{r warning=FALSE, message=FALSE}
cv_df = crossv_mc(violation_df, 100)

cv_df = 
  cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )
  
cv_df =
  cv_df %>%
  mutate(
    body_type_mod = map(.x = train, ~lm(amount_due ~ vehicle_body_type, data = .x)),
    vehicle_year_mod = map(.x = train, ~lm(amount_due ~ vehicle_year, data = .x)),
    collective_mod = map(.x = train, ~lm(amount_due ~ vehicle_year + vehicle_body_type, data = .x))
  ) %>% 
  mutate(
    rmse_body_type = map2_dbl(.x = body_type_mod, .y = test, ~rmse(model = .x, data = .y)),
    rmse_vehicle_year = map2_dbl(.x = vehicle_year_mod, .y = test, ~rmse(model = .x, data = .y)),
    rmse_collective = map2_dbl(.x = collective_mod, .y = test, ~rmse(model = .x, data = .y))
  )
```

It seems that the %%% model has the lowest Rmse value, which should be regarded as the best regression model for violation amount.

```{r}
result_df = 
  cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "Model",
    values_to = "Rmse",
    names_prefix = "rmse_"
  ) 

result_df %>% 
  mutate(Model = fct_inorder(Model)) %>% 
  ggplot(aes(x = Model, y = Rmse)) +
  geom_violin() +
  labs(
    title = "Rmse comparision in three models"
  )
```

