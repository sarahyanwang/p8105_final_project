---
title: "hydrant"
author: "Waveley Qiu (wq2162)"
date: "12/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(httr)
library(tidyverse)
library(lubridate)
library(lmtest)
library(patchwork)
library(tidygeocoder)
library(progress)
library(jsonlite)

source("code/data_cleaning.R")
source("code/formatting.R")
```

hydrant <- 
  violation %>% 
  filter(violation %in% c("FIRE HYDRANT"), !is.na(address)) 

num_groups <- 10

hydrant_split <- 
  hydrant %>% 
  group_by((row_number() - 1) %/% (n()/num_groups)) %>%
  nest %>% 
  pull(data)

hydrant_1 <- hydrant_split[[1]]
hydrant_2 <- hydrant_split[[2]]
hydrant_3 <- hydrant_split[[3]]
hydrant_4 <- hydrant_split[[4]]
hydrant_5 <- hydrant_split[[5]]
hydrant_6 <- hydrant_split[[6]]
hydrant_7 <- hydrant_split[[7]]
hydrant_8 <- hydrant_split[[8]]
hydrant_9 <- hydrant_split[[9]]
hydrant_10 <- hydrant_split[[10]]


hydrant_list <- 
  tibble(
  name = paste0("hydrant_", c(1:10)),
  data = hydrant_split
)

code_lat_long <-
  function(indf){
    temp_df <- 
      indf %>% 
      geocode(address, method = 'google', lat = latitude , long = longitude, limit = 1)
  return(temp_df)
  }

hydrant_1 <- hydrant_1 %>% code_lat_long

hydrant_lat_long <- 
  bind_rows(hydrant_1, 
          hydrant_2, 
          hydrant_3, 
          hydrant_4, 
          hydrant_5, 
          hydrant_6, 
          hydrant_7, 
          hydrant_8, 
          hydrant_9, 
          hydrant_10)

write_csv(hydrant_1, "hydrant_lat_long_1.csv")


Using NYC Geo

```{r}
hydrant <- 
  violation %>% 
  filter(violation %in% c("FIRE HYDRANT"), !is.na(geo_nyc_address)) 


pb <- progress_bar$new(total = nrow(hydrant))

get_coord <- function(url) {
  pb$tick()
  coord <- fromJSON(url(url))$features$geometry[2]
  return(coord)
}

hydrant_lat_long <- 
  hydrant %>%
  mutate(
  new_url = paste0("https://geosearch.planninglabs.nyc/v1/autocomplete?text=", geo_nyc_address, "&size=50"),
  coord = map(new_url, get_coord)
) %>%
  unnest(coord)

hydrant_lat_long %>%
  group_by(summons_number, geo_nyc_address) %>%
  slice(1)
```































